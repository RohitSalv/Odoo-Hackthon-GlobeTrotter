<app-header></app-header>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Add a class to style the date input placeholder */
        input[type="date"]:invalid::-webkit-datetime-edit {
            color: #9ca3af;
        }
        .results-container {
            transition: max-height 0.7s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        .results-container.show {
            max-height: 2500px; /* Increased for detailed content */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Smart Budget Optimizer</h1>
            <p class="text-gray-500 mt-2">AI-powered insights to maximize your savings.</p>
        </div>

        <form id="trip-form" class="space-y-6">
            <div>
                <label for="destination" class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
                <input type="text" id="destination" name="destination" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Paris, France" required>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                    <input type="date" id="start-date" name="start-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                 <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                    <input type="date" id="end-date" name="end-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="travelers" class="block text-sm font-medium text-gray-700 mb-1">Travelers</label>
                    <input type="number" id="travelers" name="travelers" value="2" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="interests" class="block text-sm font-medium text-gray-700 mb-1">Main Interest</label>
                    <select id="interests" name="interests" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option>Culture & History</option>
                        <option>Adventure & Outdoors</option>
                        <option>Shopping & Luxury</option>
                        <option>Relaxation & Wellness</option>
                    </select>
                </div>
                 <div>
                    <label for="budget" class="block text-sm font-medium text-gray-700 mb-1">Daily Budget / Person (‚Çπ)</label>
                    <input type="number" id="budget" name="budget" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Optional, e.g., 8000">
                </div>
            </div>
            <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                Generate Savings Report
            </button>
        </form>

        <div id="results-container" class="results-container mt-8">
            <div id="results-content" class="border-t border-gray-200 pt-6">
                <!-- Loader and results will be injected here -->
            </div>
        </div>
    </div>

    <script>
        async function getAIOptimization(destination, dates, travelers, interests, budget) {
            const prompt = `
                You are the "Smart Budget Optimizer," an expert travel AI. A user from Ahmedabad, India needs a detailed optimization report.
                The current date is August 11, 2025.

                User's Trip Details:
                - Destination: ${destination}
                - Planned Dates: ${dates}
                - Travelers: ${travelers}
                - Interest: ${interests}
                - Optional Daily Budget per Person: ${budget ? `‚Çπ${budget}` : 'Not provided'}

                Generate a detailed, actionable report as a single, valid JSON object. Do not include any text outside the JSON.
                The JSON object must have the following structure and content:
                {
                  "summary": {
                    "headline": "A string summarizing the total potential savings in INR (‚Çπ).",
                    "details": "A one-sentence explanation of how the biggest savings can be achieved."
                  },
                  "seasonalAnalysis": {
                    "currentCost": "A string describing the cost implications of the user's chosen dates.",
                    "whatIf": "A string with a 'what-if' scenario, comparing the trip to a different time and stating the potential savings in INR (‚Çπ)."
                  },
                  "flightAlternatives": [
                    { "type": "Date Change", "suggestion": "Specific suggestion about changing dates.", "savings": "Specific savings in ‚Çπ per person." },
                    { "type": "Airline/Route", "suggestion": "Specific suggestion about alternate routes or airlines from Ahmedabad (AMD).", "savings": "Specific savings in ‚Çπ per person." }
                  ],
                  "accommodationAlternatives": [
                    { "type": "Neighborhood", "suggestion": "Suggest a cheaper but convenient neighborhood.", "savings": "Specific savings in ‚Çπ per night." },
                    { "type": "Lodging Type", "suggestion": "Suggest an alternative lodging type like an Aparthotel or a highly-rated hostel.", "savings": "A qualitative saving description." }
                  ],
                  "activityAlternatives": [
                     { "type": "Timing/Discount", "suggestion": "Suggest a specific time-based discount, free day, or pass.", "savings": "Specific savings in ‚Çπ per person." },
                     { "type": "Local Experience", "suggestion": "Suggest a cheaper or free local alternative to a popular tourist activity.", "savings": "Specific savings in ‚Çπ per person." }
                  ],
                  "budgetAlert": {
                    "isAlert": ${budget ? 'true' : 'false'},
                    "message": "${budget ? 'Analyze the trip against the provided budget. If it exceeds, create an alert with a suggestion. If it is within budget, provide a positive confirmation.' : 'No budget provided. Skip this analysis.'}"
                  }
                }
                Use HTML <strong> tags to highlight key savings and figures. Be specific and creative.
            `;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return JSON.parse(result.candidates[0].content.parts[0].text);
                } else {
                    throw new Error("Invalid AI response structure.");
                }
            } catch (error) {
                console.error("AI Optimization Error:", error);
                return { error: "Sorry, I couldn't generate a report. The AI may be busy. Please try again in a moment." };
            }
        }

        const form = document.getElementById('trip-form');
        const resultsContainer = document.getElementById('results-container');
        const resultsContent = document.getElementById('results-content');
        const submitButton = document.getElementById('submit-button');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');

        // Set the minimum date for inputs to today
        const today = new Date().toISOString().split('T')[0];
        startDateInput.min = today;
        endDateInput.min = today;
        
        // Logic to ensure end date is not before start date
        startDateInput.addEventListener('change', function() {
            endDateInput.min = this.value;
            if (endDateInput.value && endDateInput.value < this.value) {
                endDateInput.value = '';
            }
        });

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Validate that end date is not before start date
            if (endDateInput.value && startDateInput.value > endDateInput.value) {
                resultsContent.innerHTML = `<p class="text-red-600 text-center font-bold">Error: End date cannot be before the start date.</p>`;
                resultsContainer.classList.add('show');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="flex justify-center items-center">Analyzing...</div>';
            resultsContent.innerHTML = `
                <div class="flex flex-col items-center justify-center p-4">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-600 font-medium">Generating your personalized savings report...</p>
                </div>`;
            resultsContainer.classList.add('show');
            
            const destination = document.getElementById('destination').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const travelers = document.getElementById('travelers').value;
            const interests = document.getElementById('interests').value;
            const budget = document.getElementById('budget').value;
            const dates = `${startDate} to ${endDate}`;

            const report = await getAIOptimization(destination, dates, travelers, interests, budget);
            
            submitButton.disabled = false;
            submitButton.innerHTML = 'Generate Savings Report';

            if (report.error) {
                resultsContent.innerHTML = `<p class="text-red-600 text-center font-bold">${report.error}</p>`;
            } else {
                renderReport(report);
            }
        });

        function renderReport(data) {
            const renderAlternatives = (items) => items.map(item => `
                <li class="flex items-start space-x-3">
                    <div class="flex-shrink-0 h-6 w-6 rounded-full bg-blue-100 flex items-center justify-center">
                        <span class="text-blue-600 font-bold text-xs">${item.type.charAt(0)}</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-800"><strong>${item.type}:</strong> ${item.suggestion}</p>
                        <p class="text-sm font-semibold text-green-600">Potential Savings: ${item.savings}</p>
                    </div>
                </li>
            `).join('');

            resultsContent.innerHTML = `
                <div class="space-y-8">
                    <!-- Summary -->
                    <div class="p-5 bg-blue-50 rounded-lg text-center">
                        <h2 class="text-2xl font-bold text-blue-800">${data.summary.headline}</h2>
                        <p class="text-blue-700 mt-1">${data.summary.details}</p>
                    </div>

                    <!-- Budget Alert -->
                    ${data.budgetAlert.isAlert && data.budgetAlert.message.toLowerCase().includes('exceed') ? `
                    <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
                        <h3 class="font-bold text-red-800">Budget Alert!</h3>
                        <p class="text-gray-700 mt-1">${data.budgetAlert.message}</p>
                    </div>` : ''}
                     ${data.budgetAlert.isAlert && !data.budgetAlert.message.toLowerCase().includes('exceed') ? `
                    <div class="p-4 bg-green-50 border-l-4 border-green-500 rounded-r-lg">
                        <h3 class="font-bold text-green-800">Budget Check</h3>
                        <p class="text-gray-700 mt-1">${data.budgetAlert.message}</p>
                    </div>` : ''}

                    <!-- Seasonal Analysis -->
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Seasonal & Date Analysis</h3>
                        <p class="text-gray-600">${data.seasonalAnalysis.currentCost}</p>
                        <div class="mt-3 p-3 bg-gray-100 rounded-md">
                            <p class="text-gray-800"><strong>What if?</strong> ${data.seasonalAnalysis.whatIf}</p>
                        </div>
                    </div>

                    <!-- Alternatives -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h3 class="font-semibold text-lg text-gray-800">‚úàÔ∏è Flight Alternatives</h3>
                            <ul class="space-y-4">${renderAlternatives(data.flightAlternatives)}</ul>
                        </div>
                        <div class="space-y-4">
                            <h3 class="font-semibold text-lg text-gray-800">üè® Accommodation Alternatives</h3>
                            <ul class="space-y-4">${renderAlternatives(data.accommodationAlternatives)}</ul>
                        </div>
                    </div>
                     <div class="space-y-4">
                        <h3 class="font-semibold text-lg text-gray-800">üéüÔ∏è Activity & Tour Alternatives</h3>
                        <ul class="space-y-4">${renderAlternatives(data.activityAlternatives)}</ul>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>